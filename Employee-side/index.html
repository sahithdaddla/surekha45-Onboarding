<!DOCTYPE html>
<html>
<head>
    <title>Employee Onboarding Form</title>
    <style>
        body { 
            margin: 0; 
            font-family: Arial, sans-serif; 
            background-color: #f9f9f9; 
        }
        .form-container { 
            width: 95%; 
            margin: 30px auto; 
            padding: 20px; 
            background-color: #fff; 
            border-radius: 8px; 
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); 
            height: auto; 
        }
        h2 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
        }
        .form-group {
            display: flex;
            flex-direction: column;
            margin-bottom: 15px;
            position: relative;
        }
        .fresher-checkbox-container {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 5px;
            border: 1px solid #e0e0e0;
        }
        .checkbox-label {
            display: flex;
            align-items: center;
            font-weight: 500;
            cursor: pointer;
        }
        .checkbox-label input[type="checkbox"] {
            margin-right: 10px;
            width: 18px;
            height: 18px;
        }
        .info-message {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            border-left: 3px solid #6c757d;
            margin-bottom: 15px;
        }
        label {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 5px;
            color: #555;
            display: block;
            align-items: center;
        }
        input,
        select,
        button {
            padding: 10px;
            font-size: 14px;
            border: 1px solid #ccc;
            border-radius: 4px;
            outline: none;
            transition: border-color 0.3s ease;
        }
        input:focus,
        select:focus {
            border-color: #007bff;
        }
        button {
            background-color: #28a745;
            color: #fff;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background-color: #218838;
        }
        .progress-bar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            padding: 0px 10px;
        }
        .progress-step {
            flex: 1;
            text-align: center;
            padding: 10px;
            border-bottom: 2px solid #ccc;
            color: #777;
            font-size: 14px;
            transition: color 0.3s ease, border-color 0.3s ease;
        }
        .progress-step.active {
            border-color: #007bff;
            color: #007bff;
        }
        .step {
            display: none;
        }
        .step.active {
            display: block;
        }
        .a {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: space-between;
        }
        .a .form-group {
            flex: 1;
            min-width: 200px;
        }
        .buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        .previous {
            background-color: #ffc107;
            color: #fff;
        }
        .previous:hover {
            background-color: #e0a800;
        }
        .required-star {
            color: #e74c3c;
            margin-left: 3px;
        }
        h1 {
            background: linear-gradient(135deg, #2f3790 0%, #7dacf4 100%);
            color: white;
            padding: 1.5rem;
            text-align: center;
            margin-bottom: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        #educationContainer,
        #employmentContainer {
            margin-top: 10px;
            border: 1px dashed #ccc;
            padding: 10px;
            border-radius: 4px;
            background-color: #f8f9fa;
        }
        button[type="submit"] {
            background-color: #007bff;
        }
        button[type="submit"]:hover {
            background-color: #0056b3;
        }
        button[type="button"]:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .certificates {
            width: 220px;
        }
        .error {
            border-color: red !important;
        }
        .error-message {
            color: red;
            font-size: 12px;
            margin-top: 5px;
        }
        .info-icon {
            margin-left: 5px;
            display: inline-block;
            width: 16px;
            height: 16px;
            background-color: #007bff;
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 16px;
            font-size: 12px;
            cursor: help;
            position: relative;
        }
        .info-tooltip {
            visibility: hidden;
            width: 250px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -125px;
            opacity: 0;
            transition: opacity 0.3s;
            font-weight: normal;
            font-size: 12px;
        }
        .info-tooltip::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #555 transparent transparent transparent;
        }
        .info-icon:hover .info-tooltip {
            visibility: visible;
            opacity: 1;
        }
        .file-info {
            font-size: 12px;
            color: #666;
            margin-top: 3px;
            font-style: italic;
        }
        .clear-storage-btn {
            background-color: #dc3545;
            margin-top: 20px;
        }
        .clear-storage-btn:hover {
            background-color: #c82333;
        }
    </style>
</head>

<body>
    <div class="form-container">
        <h1>Employee Onboarding Form</h1>
        <div class="progress-bar">
            <span class="progress-step active">Personal Details</span>
            <span class="progress-step">Educational Details</span>
            <span class="progress-step">Bank Details</span>
            <span class="progress-step">ID Uploads</span>
            <span class="progress-step">Previous Company</span>
        </div>

        <form id="onboardingForm">
            <!-- Step 1: Personal Details -->
            <div class="step active" id="step1">
                <h2>Personal Details</h2>
                <div class="a">
                    <div class="form-group">
                        <label for="firstName">First Name<span class="required-star">*</span></label>
                        <input type="text" id="firstName" required>
                    </div>
                    <div class="form-group">
                        <label for="lastName">Last Name<span class="required-star">*</span></label>
                        <input type="text" id="lastName" required>
                    </div>
                    <div class="form-group">
                        <label for="email">Email<span class="required-star">*</span>
                            <span class="info-icon">i
                                <span class="info-tooltip">Must start with 5+ alphanumeric characters and end with @gmail.com, @yahoo.com, or @outlook.com</span>
                            </span>
                        </label>
                        <input type="email" id="email" required>
                    </div>
                </div>
                <div class="a">
                    <div class="form-group">
                        <label for="phone">Phone Number<span class="required-star">*</span></label>
                        <input type="tel" id="phone" required>
                    </div>
                    <div class="form-group">
                        <label for="guardianName">Guardian Name<span class="required-star">*</span></label>
                        <input type="text" id="guardianName" required>
                    </div>
                    <div class="form-group">
                        <label for="guardianPhone">Guardian Phone Number<span class="required-star">*</span></label>
                        <input type="tel" id="guardianPhone" required>
                    </div>
                </div>
                <div class="a">
                    <div class="form-group">
                        <label for="DateofBirth">Date of Birth<span class="required-star">*</span></label>
                        <input type="date" id="DateofBirth" required>
                    </div>
                    <div class="form-group">
                        <label for="gender">Gender<span class="required-star">*</span></label>
                        <select id="gender" required>
                            <option value="">Select Gender</option>
                            <option value="male">Male</option>
                            <option value="female">Female</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="marital">Marital Status<span class="required-star">*</span></label>
                        <select id="marital" required>
                            <option value="">Select Status</option>
                            <option value="single">Single</option>
                            <option value="married">Married</option>
                            <option value="divorced">Divorced</option>
                        </select>
                    </div>
                </div>
                <div class="buttons">
                    <div></div>
                    <button type="button" onclick="nextStep(1)">Next</button>
                </div>
            </div>

            <!-- Step 2: Educational Details -->
            <div class="step" id="step2">
                <h2>Educational Details</h2>
                <div id="educationContainer">
                    <div class="education-entry">
                        <div class="a">
                            <div class="form-group">
                                <label for="educationType">Education Type<span class="required-star">*</span></label>
                                <select class="educationType" required onchange="updateEducationFields(this)">
                                    <option value="">Select Education Type</option>
                                    <option value="SSC">SSC</option>
                                    <option value="HSC">HSC</option>
                                    <option value="BTech">B.Tech</option>
                                    <option value="Degree">Degree</option>
                                </select>
                            </div>
                            <div class="form-group institution-group">
                                <label for="institutionName">Institution Name<span class="required-star">*</span></label>
                                <input type="text" class="institutionName" required>
                            </div>
                            <div class="form-group branch-group" style="display: none;">
                                <label for="branch">Branch<span class="required-star">*</span></label>
                                <input type="text" class="branch" required>
                            </div>
                        </div>
                        <div class="a">
                            <div class="form-group">
                                <label for="passoutYear">Passed Out Year<span class="required-star">*</span></label>
                                <input 
                                    type="number" 
                                    class="passoutYear" 
                                    min="1990" 
                                    max="2025" 
                                    step="1"
                                    required
                                    maxlength="4"
                                    oninput="this.value = this.value.replace(/[eE]/g, '').slice(0, 4)"
                                    onkeydown="return event.key !== 'e' && event.key !== 'E'"
                                >
                            </div>
                            <div class="form-group">
                                <label for="percentage">Pass Percentage<span class="required-star">*</span></label>
                                <input 
                                    type="number" 
                                    class="percentage" 
                                    min="10" 
                                    max="100" 
                                    step="0.5"
                                    required
                                    onkeydown="return event.key !== 'e' && event.key !== 'E'"
                                    oninput="this.value = this.value.replace(/[eE]/g, '')"
                                >
                            </div>
                            <div class="form-group">
                                <label for="location">Location<span class="required-star">*</span></label>
                                <input type="text" class="location" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="certificates">Certificate<span class="required-star">*</span></label>
                            <input type="file" class="certificates" accept=".jpg,.jpeg,.png,.pdf" required>
                            <div class="file-info">Supported formats: JPG, PNG, PDF (Max: 1MB)</div>
                        </div>
                    </div>
                </div>
                <button type="button" id="addEducationBtn" onclick="addEducation()" style="margin-top: 20px;">+ Add More Education</button>
                <div class="buttons">
                    <button type="button" class="previous" onclick="previousStep(2)">Previous</button>
                    <button type="button" onclick="nextStep(2)">Next</button>
                </div>
            </div>

            <!-- Step 3: Bank Details -->
            <div class="step" id="step3">
                <h2>Bank Details</h2>
                <div class="a">
                    <div class="form-group">
                        <label for="accountHolder">Account Holder Name<span class="required-star">*</span></label>
                        <input type="text" id="accountHolder" required>
                    </div>
                    <div class="form-group">
                        <label for="bankName">Name of the Bank<span class="required-star">*</span></label>
                        <input type="text" id="bankName" required>
                    </div>
                    <div class="form-group">
                        <label for="accountNumber">Account Number<span class="required-star">*</span></label>
                        <input type="text" id="accountNumber" required>
                    </div>
                </div>
                <div class="a">
                    <div class="form-group">
                        <label for="bankBranch">Branch<span class="required-star">*</span></label>
                        <input type="text" id="bankBranch" required>
                    </div>
                    <div class="form-group">
                        <label for="ifscCode">IFSC Code<span class="required-star">*</span></label>
                        <input type="text" id="ifscCode" required maxlength="11">
                    </div>
                    <div class="form-group">
                        <label for="bankLocation">Location<span class="required-star">*</span></label>
                        <input type="text" id="bankLocation" required>
                    </div>
                    <div class="form-group">
                        <label for="pinCode">Pin Code<span class="required-star">*</span></label>
                        <input type="text" id="pinCode" pattern="[0-9]{6}" required>
                    </div>
                </div>
                <div class="buttons">
                    <button type="button" class="previous" onclick="previousStep(3)">Previous</button>
                    <button type="button" onclick="nextStep(3)">Next</button>
                </div>
            </div>

            <!-- Step 4: ID Uploads -->
            <div class="step" id="step4">
                <h2>ID Uploads</h2>
                <div id="IDuploads">
                    <div class="a">
                        <div class="form-group">
                            <label for="panCard">PAN Card<span class="required-star">*</span></label>
                            <input type="file" id="panCard" accept=".jpg,.jpeg,.png,.pdf" required>
                            <div class="file-info">Supported formats: JPG, PNG, PDF (Max: 1MB)</div>
                        </div>
                        <div class="form-group">
                            <label for="aadharCard">Aadhar Card<span class="required-star">*</span></label>
                            <input type="file" id="aadharCard" accept=".jpg,.jpeg,.png,.pdf" required>
                            <div class="file-info">Supported formats: JPG, PNG, PDF (Max: 1MB)</div>
                        </div>
                        <div class="form-group">
                            <label for="passport">Passport<span class="required-star">*</span></label>
                            <input type="file" id="passport" accept=".jpg,.jpeg,.png,.pdf" required>
                            <div class="file-info">Supported formats: JPG, PNG, PDF (Max: 1MB)</div>
                        </div>
                    </div>
                </div>
                <div class="buttons">
                    <button type="button" class="previous" onclick="previousStep(4)">Previous</button>
                    <button type="button" onclick="nextStep(4)">Next</button>
                </div>
            </div>

            <!-- Step 5: Previous Company -->
            <div class="step" id="step5">
                <h2>Previous Company Details</h2>
                <div class="form-group fresher-checkbox-container">
                    <label for="isFresher" class="checkbox-label">
                        <input type="checkbox" id="isFresher" name="isFresher"> 
                        I am a fresher with no prior work experience
                    </label>
                </div>
                <div id="employmentContainer">
                    <div class="employment-entry">
                        <div class="a">
                            <div class="form-group">
                                <label for="prevCompany">Company Name<span class="required-star">*</span></label>
                                <input type="text" class="prevCompany" required>
                            </div>
                            <div class="form-group">
                                <label for="designation">Designation<span class="required-star">*</span></label>
                                <input type="text" class="designation" required>
                            </div>
                            <div class="form-group">
                                <label for="experience">Years of Experience<span class="required-star">*</span></label>
                                <input 
                                    type="number" 
                                    class="experience" 
                                    min="0.5" 
                                    max="50"
                                    step="0.5"
                                    onkeydown="return event.key !== 'e' && event.key !== 'E'"
                                    oninput="this.value = this.value.replace(/[eE]/g, '')"
                                    required>
                            </div>
                        </div>
                        <div class="a">
                            <div class="form-group">
                                <label for="startDate">Start Date<span class="required-star">*</span></label>
                                <input type="date" class="startDate" required>
                            </div>
                            <div class="form-group">
                                <label for="endDate">End Date<span class="required-star">*</span></label>
                                <input type="date" class="endDate" required>
                            </div>
                            <div class="form-group">
                                <label for="location">Location<span class="required-star">*</span></label>
                                <input type="text" class="location" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="relievingLetter">Relieving Letter<span class="required-star">*</span></label>
                            <input type="file" class="relievingLetter" accept=".jpg,.jpeg,.png,.pdf" required>
                            <div class="file-info">Supported formats: JPG, PNG, PDF (Max: 1MB)</div>
                        </div>
                        <div class="form-group">
                            <label for="experienceLetter">Experience Letter<span class="required-star">*</span></label>
                            <input type="file" class="experienceLetter" accept=".jpg,.jpeg,.png,.pdf" required>
                            <div class="file-info">Supported formats: JPG, PNG, PDF (Max: 1MB)</div>
                        </div>
                    </div>
                </div>
                <button type="button" onclick="addEmployment()" style="margin-top: 40px;">+ Add More Employment</button>
                <div class="buttons">
                    <button type="button" class="previous" onclick="previousStep(5)">Previous</button>
                    <button type="submit">Submit</button>
                </div>
            </div>
        </form>
    </div>

    <script>
  const apiBaseUrl = 'http://56.228.41.185:3608/api';

// Global variables
let currentStep = 1;
const totalSteps = 5;
const maxEducationEntries = 5;
const maxEmploymentEntries = 10;
const maxFileSize = 1 * 1024 * 1024; // 1MB limit

// Validation functions
function validateIFSCCode(ifscCode) {
    const ifscPattern = /^[A-Z]{4}0[A-Z0-9]{6}$/;
    return ifscPattern.test(ifscCode);
}

function validatePhoneNumber(phone) {
    const phonePattern = /^[6-9]\d{9}$/;
    return phonePattern.test(phone);
}

function validatePinCode(pinCode) {
    const pinCodePattern = /^[1-9][0-9]{5}$/;
    if (!pinCodePattern.test(pinCode)) return false;
    const uniqueDigits = new Set(pinCode.split('')).size;
    if (uniqueDigits === 1) return false;
    return true;
}

function validateBankAccountNumber(accountNumber) {
    const accountPattern = /^[1-9][0-9]{8,17}$/;
    if (!accountPattern.test(accountNumber)) return false;
    const uniqueDigits = new Set(accountNumber.split('')).size;
    if (uniqueDigits === 1) return false;
    return true;
}

function calculateYearsBetweenDates(startDate, endDate) {
    const start = new Date(startDate);
    const end = new Date(endDate);
    const diffTime = end - start;
    const diffYears = diffTime / (1000 * 60 * 60 * 24 * 365.25);
    return Math.round(diffYears * 10) / 10;
}

function clearError(input) {
    input.classList.remove('error');
    const errorMessage = input.parentElement.querySelector('.error-message');
    if (errorMessage) {
        errorMessage.remove();
    }
}

function addErrorMessage(input, message) {
    const existingError = input.parentElement.querySelector('.error-message');
    if (existingError) {
        existingError.remove();
    }
    
    const errorDiv = document.createElement('div');
    errorDiv.className = 'error-message';
    errorDiv.textContent = message;
    input.parentElement.appendChild(errorDiv);
}

function setupInputRestrictions() {
    const restrictedFields = [
        'firstName', 'lastName', 'guardianName', 'institutionName', 'branch', 'location',
        'accountHolder', 'bankName', 'bankBranch', 'bankLocation', 'prevCompany', 'designation'
    ];
    
    restrictedFields.forEach(fieldName => {
        const elements = document.querySelectorAll(`#${fieldName}, .${fieldName}`);
        elements.forEach(element => {
            element.addEventListener('keypress', function(e) {
                const char = String.fromCharCode(e.charCode || e.which);
                const currentValue = this.value;
                
                if (!/[a-zA-Z\s]/.test(char)) {
                    e.preventDefault();
                    return;
                }
                
                if (char === ' ' && currentValue.endsWith(' ')) {
                    e.preventDefault();
                    return;
                }
                
                if (currentValue.length >= 50) {
                    e.preventDefault();
                    return;
                }
            });
            
            element.addEventListener('input', function() {
                let value = this.value;
                value = value.replace(/[^a-zA-Z\s]/g, '');
                value = value.replace(/\s+/g, ' ').trimStart();
                if (value.length > 50) {
                    value = value.slice(0, 50);
                }
                this.value = value;
                if (value.length > 0 && value.length < 2) {
                    this.classList.add('error');
                    addErrorMessage(this, 'Must be at least 2 characters');
                } else {
                    clearError(this);
                }
            });
            
            element.addEventListener('blur', function() {
                const value = this.value.trim();
                if (value.length > 0 && value.length < 2) {
                    this.classList.add('error');
                    addErrorMessage(this, 'Must be at least 2 characters');
                } else {
                    clearError(this);
                }
            });
        });
    });

    const ifscInput = document.getElementById('ifscCode');
    if (ifscInput) {
        ifscInput.addEventListener('input', function() {
            let value = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
            if (value.length > 11) {
                value = value.slice(0, 11);
            }
            this.value = value;
            if (value.length > 0 && !validateIFSCCode(value)) {
                this.classList.add('error');
                addErrorMessage(this, 'Invalid IFSC Code. Must be 11 characters (4 letters, 0, 6 alphanumeric)');
            } else {
                clearError(this);
            }
        });
    }
}

function handleFresherCheckbox() {
    const fresherCheckbox = document.getElementById('isFresher');
    const employmentContainer = document.getElementById('employmentContainer');
    const addEmploymentButton = document.querySelector('button[onclick="addEmployment()"]');
    
    if (!fresherCheckbox) return;
    
    if (fresherCheckbox.checked) {
        employmentContainer.querySelectorAll('input').forEach(input => {
            input.disabled = true;
            input.value = '';
            clearError(input);
            if (input.hasAttribute('required')) {
                input.setAttribute('data-was-required', 'true');
                input.removeAttribute('required');
            }
        });
        addEmploymentButton.disabled = true;
        addEmploymentButton.style.opacity = '0.5';
        document.querySelectorAll('.remove-employment').forEach(btn => {
            btn.style.display = 'none';
        });
        
        const messageDiv = document.createElement('div');
        messageDiv.id = 'fresher-message';
        messageDiv.className = 'info-message';
        messageDiv.textContent = 'Employment details not required for freshers';
        messageDiv.style.color = '#666';
        messageDiv.style.fontStyle = 'italic';
        messageDiv.style.margin = '10px 0 15px';
        
        if (!document.getElementById('fresher-message')) {
            employmentContainer.parentNode.insertBefore(messageDiv, employmentContainer);
        }
    } else {
        employmentContainer.querySelectorAll('input').forEach(input => {
            input.disabled = false;
            if (input.getAttribute('data-was-required') === 'true') {
                input.setAttribute('required', '');
            }
        });
        addEmploymentButton.disabled = false;
        addEmploymentButton.style.opacity = '1';
        document.querySelectorAll('.remove-employment').forEach(btn => {
            btn.style.display = 'block';
        });
        
        const messageDiv = document.getElementById('fresher-message');
        if (messageDiv) {
            messageDiv.remove();
        }
    }
}

function validateEmploymentEntries() {
    const fresherCheckbox = document.getElementById('isFresher');
    if (fresherCheckbox?.checked) return true;
    
    const employmentEntries = document.querySelectorAll('.employment-entry');
    let isValid = true;

    employmentEntries.forEach(entry => {
        const inputs = entry.querySelectorAll('input[required]');
        const hasAnyValue = Array.from(inputs).some(input => input.value.trim() !== '');
        
        if (hasAnyValue || document.getElementById('onboardingForm')?.getAttribute('data-submitting') === 'true') {
            inputs.forEach(input => {
                if (!input.value) {
                    isValid = false;
                    input.classList.add('error');
                    addErrorMessage(input, `${input.previousElementSibling.textContent.replace('*', '').trim()} is required`);
                } else if (!validateInput(input)) {
                    isValid = false;
                }
            });

            const startDate = entry.querySelector('.startDate').value;
            const endDate = entry.querySelector('.endDate').value;
            const experience = parseFloat(entry.querySelector('.experience').value);
            if (startDate && endDate && !isNaN(experience)) {
                const calculatedYears = calculateYearsBetweenDates(startDate, endDate);
                if (Math.abs(calculatedYears - experience) > 0.1) {
                    isValid = false;
                    const experienceInput = entry.querySelector('.experience');
                    experienceInput.classList.add('error');
                    addErrorMessage(experienceInput, `Years of experience (${experience}) does not match duration between dates (${calculatedYears.toFixed(1)} years)`);
                }
            }
        }
    });
    return isValid;
}

function validateInput(input) {
    clearError(input);
    if (!input.value && input.hasAttribute('required')) return false;

    let isValid = true;
    let errorMessage = '';
    const dob = document.getElementById('DateofBirth')?.value;
    const dobDate = dob ? new Date(dob) : null;

    switch(input.type) {
        case 'text':
            if (input.id === 'ifscCode') {
                if (!validateIFSCCode(input.value)) {
                    isValid = false;
                    errorMessage = 'Invalid IFSC Code. Must be 11 characters (4 letters, 0, 6 alphanumeric)';
                }
            } else if (['firstName', 'lastName', 'guardianName', 'accountHolder', 'bankName', 'bankBranch', 'bankLocation'].includes(input.id) ||
                       ['institutionName', 'branch', 'location', 'prevCompany', 'designation'].some(cls => input.classList.contains(cls))) {
                const value = input.value.trim();
                if (!/^[a-zA-Z\s]+$/.test(value)) {
                    isValid = false;
                    errorMessage = 'Only alphabets and single spaces allowed';
                } else if (value.length < 2) {
                    isValid = false;
                    errorMessage = 'Minimum 2 characters required';
                } else if (value.length > 50) {
                    isValid = false;
                    errorMessage = 'Must not exceed 50 characters';
                } else if (value.includes('  ')) {
                    isValid = false;
                    errorMessage = 'Multiple consecutive spaces not allowed';
                } else if (!/[a-zA-Z]/.test(value)) {
                    isValid = false;
                    errorMessage = 'At least one alphabet required';
                }
            } else if (input.id === 'accountNumber') {
                if (!validateBankAccountNumber(input.value)) {
                    isValid = false;
                    errorMessage = 'Account number must be 9-18 digits, not all same digits';
                }
            } else if (input.id === 'pinCode') {
                if (!validatePinCode(input.value)) {
                    isValid = false;
                    errorMessage = 'Pin code must be 6 digits, not all same digits';
                }
            }
            break;

        case 'email':
            const emailPattern = /^[A-Za-z0-9][A-Za-z0-9._]{4,}@(gmail\.com|yahoo\.com|outlook\.com)$/;
            if (!emailPattern.test(input.value)) {
                isValid = false;
                errorMessage = 'Email must be 5+ alphanumeric chars, @gmail.com, @yahoo.com, or @outlook.com';
            } else if (input.value.match(/@.*\..*\./)) {
                isValid = false;
                errorMessage = 'No characters allowed after .com';
            }
            break;

        case 'tel':
            if (!validatePhoneNumber(input.value)) {
                isValid = false;
                errorMessage = 'Phone number must be 10 digits starting with 6-9';
            }
            if (input.id === 'phone' || input.id === 'guardianPhone') {
                const phone = document.getElementById('phone')?.value;
                const guardianPhone = document.getElementById('guardianPhone')?.value;
                if (phone && guardianPhone && phone === guardianPhone) {
                    isValid = false;
                    errorMessage = 'Phone and guardian phone cannot be the same';
                }
            }
            break;

        case 'file':
            if (input.files && input.files[0]) {
                const allowedTypes = ['image/jpeg', 'image/png', 'application/pdf'];
                if (!allowedTypes.includes(input.files[0].type)) {
                    isValid = false;
                    errorMessage = 'Only JPG, PNG, or PDF allowed';
                } else if (input.files[0].size > maxFileSize) {
                    isValid = false;
                    errorMessage = 'File size exceeds 1MB';
                }
            } else if (input.hasAttribute('required')) {
                isValid = false;
                errorMessage = 'File is required';
            }
            break;

        case 'date':
            const inputDate = new Date(input.value);
            const today = new Date();
            
            if (input.classList.contains('startDate') || input.classList.contains('endDate')) {
                const minDate = new Date('1990-01-01');
                if (inputDate < minDate) {
                    isValid = false;
                    errorMessage = 'Date must be after 1990';
                } else if (inputDate > today) {
                    isValid = false;
                    errorMessage = 'Date cannot be in future';
                }
                if (dobDate) {
                    const minWorkDate = new Date(dobDate);
                    minWorkDate.setFullYear(minWorkDate.getFullYear() + 20);
                    if (inputDate < minWorkDate) {
                        isValid = false;
                        errorMessage = 'Work date must be 20 years after DOB';
                    }
                }
            }
            
            if (input.classList.contains('endDate')) {
                const startDate = input.closest('.employment-entry')?.querySelector('.startDate').value;
                if (startDate && new Date(input.value) < new Date(startDate)) {
                    isValid = false;
                    errorMessage = 'End date cannot be before start date';
                }
            }
            
            if (input.id === 'DateofBirth') {
                const minAge = 20;
                const minDate = new Date(today.getFullYear() - minAge, today.getMonth(), today.getDate());
                const minAllowedDate = new Date('1970-01-01');
                
                if (inputDate > today) {
                    isValid = false;
                    errorMessage = 'DOB cannot be in future';
                } else if (inputDate > minDate) {
                    isValid = false;
                    errorMessage = `Age must be at least ${minAge} years`;
                } else if (inputDate < minAllowedDate) {
                    isValid = false;
                    errorMessage = 'DOB must be after 1970';
                }
            }
            break;

        case 'number':
            if (input.classList.contains('passoutYear')) {
                const year = parseInt(input.value);
                const currentYear = new Date().getFullYear();
                if (year < 1990 || year > currentYear) {
                    isValid = false;
                    errorMessage = `Year must be between 1990 and ${currentYear}`;
                }
                if (dobDate) {
                    const dobYear = dobDate.getFullYear();
                    const educationType = input.closest('.education-entry')?.querySelector('.educationType').value;
                    let minEduYear, maxEduYear;
                    if (educationType === 'SSC') {
                        minEduYear = dobYear + 15;
                        maxEduYear = dobYear + 16;
                    } else if (educationType === 'HSC') {
                        minEduYear = dobYear + 18;
                        maxEduYear = dobYear + 19;
                    } else if (educationType === 'BTech' || educationType === 'Degree') {
                        minEduYear = dobYear + 21;
                        maxEduYear = dobYear + 23;
                    }
                    if (minEduYear && maxEduYear && (year < minEduYear || year > maxEduYear)) {
                        isValid = false;
                        errorMessage = `${educationType} passout year must be between ${minEduYear} and ${maxEduYear}`;
                    }
                }
            } else if (input.classList.contains('percentage')) {
                const percentage = parseFloat(input.value);
                if (isNaN(percentage) || percentage < 10 || percentage > 100) {
                    isValid = false;
                    errorMessage = 'Percentage must be between 10 and 100';
                } else if (!/^\d+(\.\d)?$/.test(input.value)) {
                    isValid = false;
                    errorMessage = 'Percentage must be in format like 10 or 10.5';
                }
            } else if (input.classList.contains('experience')) {
                const value = parseFloat(input.value);
                if (isNaN(value) || value < 0.5 || value > 50) {
                    isValid = false;
                    errorMessage = 'Experience must be between 0.5 and 50 years';
                } else if (!/^\d+(\.\d)?$/.test(input.value)) {
                    isValid = false;
                    errorMessage = 'Experience must be in format like 0.5 or 1.0';
                }
                const entry = input.closest('.employment-entry');
                const startDate = entry?.querySelector('.startDate').value;
                const endDate = entry?.querySelector('.endDate').value;
                if (startDate && endDate) {
                    const calculatedYears = calculateYearsBetweenDates(startDate, endDate);
                    if (Math.abs(calculatedYears - value) > 0.1) {
                        isValid = false;
                        errorMessage = `Experience (${value}) does not match dates (${calculatedYears.toFixed(1)} years)`;
                    }
                }
            }
            break;
    }

    if (!isValid && errorMessage) {
        input.classList.add('error');
        addErrorMessage(input, errorMessage);
    }

    return isValid;
}

function updateEducationFields(selectElement) {
    const entry = selectElement.closest('.education-entry');
    const institutionGroup = entry.querySelector('.institution-group');
    const branchGroup = entry.querySelector('.branch-group');
    const educationType = selectElement.value;

    if (educationType === 'SSC') {
        institutionGroup.querySelector('label').textContent = 'School Name';
        branchGroup.style.display = 'none';
        branchGroup.querySelector('input').removeAttribute('required');
    } else {
        institutionGroup.querySelector('label').textContent = educationType === 'HSC' || educationType === 'BTech' || educationType === 'Degree' ? 'College Name' : 'Institution Name';
        branchGroup.style.display = educationType === 'HSC' || educationType === 'BTech' || educationType === 'Degree' ? 'block' : 'none';
        if (educationType === 'HSC' || educationType === 'BTech' || educationType === 'Degree') {
            branchGroup.querySelector('input').setAttribute('required', '');
        } else {
            branchGroup.querySelector('input').removeAttribute('required');
        }
    }

    const passoutYearInput = entry.querySelector('.passoutYear');
    const dob = document.getElementById('DateofBirth')?.value;
    if (dob) {
        const dobYear = new Date(dob).getFullYear();
        if (educationType === 'SSC') {
            passoutYearInput.min = dobYear + 15;
            passoutYearInput.max = dobYear + 16;
        } else if (educationType === 'HSC') {
            passoutYearInput.min = dobYear + 18;
            passoutYearInput.max = dobYear + 19;
        } else if (educationType === 'BTech' || educationType === 'Degree') {
            passoutYearInput.min = dobYear + 21;
            passoutYearInput.max = dobYear + 23;
        } else {
            passoutYearInput.min = '1990';
            passoutYearInput.max = new Date().getFullYear();
        }
    }
    validateInput(passoutYearInput);
}

function validateEducationEntries() {
    const educationEntries = document.querySelectorAll('.education-entry');
    let isValid = true;

    educationEntries.forEach(entry => {
        const inputs = entry.querySelectorAll('input[required], select[required]');
        inputs.forEach(input => {
            if (!input.value) {
                isValid = false;
                input.classList.add('error');
                addErrorMessage(input, `${input.previousElementSibling.textContent.replace('*', '').trim()} is required`);
            } else if (!validateInput(input)) {
                isValid = false;
            }
        });
    });

    return isValid;
}

function addEducation() {
    const educationEntries = document.querySelectorAll('.education-entry').length;
    if (educationEntries >= maxEducationEntries) {
        alert('Maximum 5 education entries allowed');
        return;
    }

    const container = document.getElementById('educationContainer');
    const template = container.querySelector('.education-entry').cloneNode(true);
    
    template.querySelectorAll('input, select').forEach(input => {
        input.value = '';
        clearError(input);
        
        input.addEventListener('input', function() {
            validateInput(this);
        });
        
        input.addEventListener('blur', function() {
            if (this.value) {
                validateInput(this);
            }
        });

        if (input.classList.contains('educationType')) {
            input.addEventListener('change', function() {
                updateEducationFields(this);
            });
        }
    });
    
    template.querySelector('.branch-group').style.display = 'none';
    template.querySelector('.branch').removeAttribute('required');
    template.querySelector('.institution-group label').textContent = 'Institution Name';
    
    container.appendChild(template);
    addRemoveButtons();
    setupInputRestrictions();
}

function addEmployment() {
    const employmentEntries = document.querySelectorAll('.employment-entry').length;
    if (employmentEntries >= maxEmploymentEntries) {
        alert('Maximum 10 employment entries allowed');
        return;
    }
    
    const container = document.getElementById('employmentContainer');
    const template = container.querySelector('.employment-entry').cloneNode(true);
    
    template.querySelectorAll('input').forEach(input => {
        input.value = '';
        clearError(input);
        
        if (input.classList.contains('startDate') || input.classList.contains('endDate')) {
            const today = new Date().toISOString().split('T')[0];
            input.setAttribute('max', today);
            input.setAttribute('min', '1990-01-01');
        }
        
        input.addEventListener('input', function() {
            validateInput(this);
        });
        
        input.addEventListener('blur', function() {
            if (this.value) {
                validateInput(this);
            }
        });
    });
    
    container.appendChild(template);
    addRemoveButtons();
    setupInputRestrictions();
}

function addRemoveButtons() {
    document.querySelectorAll('#educationContainer .education-entry').forEach((entry, index) => {
        const existingRemoveBtn = entry.querySelector('.remove-education');
        if (existingRemoveBtn) existingRemoveBtn.remove();

        if (document.querySelectorAll('#educationContainer .education-entry').length > 1) {
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.textContent = '- Remove Education';
            removeBtn.style.margin = '10px 0 20px';
            removeBtn.className = 'remove-education';
            removeBtn.onclick = function() {
                entry.remove();
                addRemoveButtons();
            };
            entry.appendChild(removeBtn);
        }
    });

    document.querySelectorAll('#employmentContainer .employment-entry').forEach((entry, index) => {
        const existingRemoveBtn = entry.querySelector('.remove-employment');
        if (existingRemoveBtn) existingRemoveBtn.remove();

        if (document.querySelectorAll('#employmentContainer .employment-entry').length > 1) {
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.textContent = '- Remove Employment';
            removeBtn.style.margin = '10px 0 20px';
            removeBtn.className = 'remove-employment';
            removeBtn.onclick = function() {
                entry.remove();
                addRemoveButtons();
            };
            entry.appendChild(removeBtn);
        }
    });
}

function addInfoIcons() {
    const documentLabels = {
        'panCard': 'Supported formats: JPG, PNG, PDF (Max: 1MB)',
        'aadharCard': 'Supported formats: JPG, PNG, PDF (Max: 1MB)',
        'passport': 'Supported formats: JPG, PNG, PDF (Max: 1MB)',
        'relievingLetter': 'Supported formats: JPG, PNG, PDF (Max: 1MB)',
        'experienceLetter': 'Supported formats: JPG, PNG, PDF (Max: 1MB)'
    };
    
    for (const [id, hint] of Object.entries(documentLabels)) {
        const label = document.querySelector(`label[for="${id}"]`);
        if (label) {
            const infoIcon = document.createElement('span');
            infoIcon.innerHTML = ' ⓘ';
            infoIcon.className = 'info-icon';
            infoIcon.title = hint;
            infoIcon.style.cursor = 'pointer';
            label.appendChild(infoIcon);
        }
    }
    
    document.querySelectorAll('input[type="file"]').forEach(input => {
        const label = input.previousElementSibling;
        if (label && !label.querySelector('.info-icon')) {
            const infoIcon = document.createElement('span');
            infoIcon.innerHTML = ' ⓘ';
            infoIcon.className = 'info-icon';
            infoIcon.title = 'Supported formats: JPG, PNG, PDF (Max: 1MB)';
            infoIcon.style.cursor = 'pointer';
            label.appendChild(infoIcon);
        }
    });

    const fieldsToAddInfoIcons = ['accountNumber', 'ifscCode', 'phone', 'guardianPhone', 'DateofBirth', 'pinCode'];
    fieldsToAddInfoIcons.forEach(fieldId => {
        const label = document.querySelector(`label[for="${fieldId}"]`);
        if (label && !label.querySelector('.info-icon')) {
            const infoIcon = document.createElement('span');
            infoIcon.innerHTML = ' ⓘ';
            infoIcon.className = 'info-icon';
            let tooltipText = '';
            switch (fieldId) {
                case 'accountNumber': tooltipText = 'Must be 9-18 digits, not all same digits'; break;
                case 'ifscCode': tooltipText = 'Format: 4 letters, 0, 6 alphanumeric chars'; break;
                case 'phone': case 'guardianPhone': tooltipText = 'Must be 10 digits starting with 6-9'; break;
                case 'DateofBirth': tooltipText = 'Must be after 1970, age at least 20 years'; break;
                case 'pinCode': tooltipText = 'Must be 6 digits, not all same digits'; break;
            }
            infoIcon.title = tooltipText;
            infoIcon.style.cursor = 'pointer';
            label.appendChild(infoIcon);
        }
    });
}

function configureDateOfBirth() {
    const dobInput = document.getElementById('DateofBirth');
    if (dobInput) {
        const today = new Date();
        const minAge = 20;
        const maxDate = new Date(today.getFullYear() - minAge, today.getMonth(), today.getDate());
        dobInput.max = maxDate.toISOString().split('T')[0];
        dobInput.min = '1970-01-01';
        dobInput.addEventListener('change', function() {
            document.querySelectorAll('.education-entry').forEach(entry => {
                const educationTypeSelect = entry.querySelector('.educationType');
                if (educationTypeSelect.value) {
                    updateEducationFields(educationTypeSelect);
                }
            });
        });
    }
}

function fileToBase64(file) {
    return new Promise((resolve, reject) => {
        if (!file) {
            resolve(null);
            return;
        }
        if (file.size > maxFileSize) {
            reject(new Error('File size exceeds 1MB'));
            return;
        }
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
        reader.readAsDataURL(file);
    });
}

async function collectFormData() {
    const formData = {
        personalDetails: {
            firstName: document.getElementById('firstName').value,
            lastName: document.getElementById('lastName').value,
            email: document.getElementById('email').value,
            phone: document.getElementById('phone').value,
            guardianName: document.getElementById('guardianName').value,
            guardianPhone: document.getElementById('guardianPhone').value,
            dateOfBirth: document.getElementById('DateofBirth').value,
            gender: document.getElementById('gender').value,
            maritalStatus: document.getElementById('marital').value
        },
        educationalDetails: [],
        bankDetails: {
            accountHolder: document.getElementById('accountHolder').value,
            bankName: document.getElementById('bankName').value,
            accountNumber: document.getElementById('accountNumber').value,
            bankBranch: document.getElementById('bankBranch').value,
            ifscCode: document.getElementById('ifscCode').value,
            bankLocation: document.getElementById('bankLocation').value,
            pinCode: document.getElementById('pinCode').value
        },
        idUploads: {},
        previousCompany: [],
        isFresher: document.getElementById('isFresher')?.checked || false
    };
    
    // Collect ID uploads
    const idFields = ['panCard', 'aadharCard', 'passport'];
    for (const field of idFields) {
        const fileInput = document.getElementById(field);
        if (fileInput && fileInput.files[0]) {
            try {
                const base64 = await fileToBase64(fileInput.files[0]);
                formData.idUploads[field] = {
                    name: fileInput.files[0].name,
                    type: fileInput.files[0].type,
                    data: base64
                };
            } catch (error) {
                console.error(`Error converting ${field} to Base64:`, error);
            }
        }
    }

    // Collect educational details
    const educationEntries = document.querySelectorAll('.education-entry');
    for (const entry of educationEntries) {
        const educationType = entry.querySelector('.educationType').value;
        const institutionName = entry.querySelector('.institutionName').value;
        const branch = entry.querySelector('.branch').value;
        const passoutYear = entry.querySelector('.passoutYear').value;
        const percentage = entry.querySelector('.percentage').value;
        const location = entry.querySelector('.location').value;
        const certificateInput = entry.querySelector('.certificates');
        let certificate = null;

        if (certificateInput && certificateInput.files[0]) {
            try {
                const base64 = await fileToBase64(certificateInput.files[0]);
                certificate = {
                    name: certificateInput.files[0].name,
                    type: certificateInput.files[0].type,
                    data: base64
                };
            } catch (error) {
                console.error('Error converting certificate to Base64:', error);
            }
        }

        if (educationType && institutionName && passoutYear && percentage && location) {
            formData.educationalDetails.push({
                educationType,
                institutionName,
                branch: educationType === 'HSC' || educationType === 'BTech' || educationType === 'Degree' ? branch : null,
                passoutYear: parseInt(passoutYear),
                percentage: parseFloat(percentage),
                location,
                certificate
            });
        }
    }

    // Collect employment details
    if (!formData.isFresher) {
        const employmentEntries = document.querySelectorAll('.employment-entry');
        for (const entry of employmentEntries) {
            const companyName = entry.querySelector('.prevCompany').value;
            const designation = entry.querySelector('.designation').value;
            const experience = entry.querySelector('.experience').value;
            const startDate = entry.querySelector('.startDate').value;
            const endDate = entry.querySelector('.endDate').value;
            const location = entry.querySelector('.location').value;
            const relievingLetterInput = entry.querySelector('.relievingLetter');
            const experienceLetterInput = entry.querySelector('.experienceLetter');
            let relievingLetter = null;
            let experienceLetter = null;

            if (relievingLetterInput && relievingLetterInput.files[0]) {
                try {
                    const base64 = await fileToBase64(relievingLetterInput.files[0]);
                    relievingLetter = {
                        name: relievingLetterInput.files[0].name,
                        type: relievingLetterInput.files[0].type,
                        data: base64
                    };
                } catch (error) {
                    console.error('Error converting relieving letter to Base64:', error);
                }
            }
            if (experienceLetterInput && experienceLetterInput.files[0]) {
                try {
                    const base64 = await fileToBase64(experienceLetterInput.files[0]);
                    experienceLetter = {
                        name: experienceLetterInput.files[0].name,
                        type: experienceLetterInput.files[0].type,
                        data: base64
                    };
                } catch (error) {
                    console.error('Error converting experience letter to Base64:', error);
                }
            }

            if (companyName && designation && experience && startDate && endDate && location) {
                formData.previousCompany.push({
                    companyName,
                    designation,
                    experience: parseFloat(experience),
                    startDate,
                    endDate,
                    location,
                    relievingLetter,
                    experienceLetter
                });
            }
        }
    }

    return formData;
}

async function saveFormData(formData) {
    try {
        const response = await fetch(`${apiBaseUrl}/employees`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
        });
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Failed to save form data');
        }
        const savedData = await response.json();
        console.log('Saved data from server:', savedData); // Debug log
        // Normalize snake_case to camelCase
        const normalizedData = {
            personalDetails: savedData.personal_details || {},
            educationalDetails: savedData.educational_details || [],
            bankDetails: savedData.bank_details || {},
            idUploads: savedData.id_uploads || {},
            previousCompany: savedData.previous_company || [],
            isFresher: savedData.is_fresher || false
        };
        normalizedData.progress = calculateProgress(normalizedData);
        return normalizedData;
    } catch (error) {
        console.error('Error saving form data:', error);
        throw error;
    }
}

function calculateProgress(formData) {
    console.log('Calculating progress for:', formData); // Debug log
    const totalSections = 5;
    let completedSections = 0;

    // Personal Details: Check if key fields are present
    if (
        formData.personalDetails?.firstName?.trim() &&
        formData.personalDetails?.lastName?.trim() &&
        formData.personalDetails?.email?.trim()
    ) {
        completedSections++;
        console.log('Personal Details section completed');
    }

    // Educational Details: Check if at least one entry exists
    if (Array.isArray(formData.educationalDetails) && formData.educationalDetails.length > 0) {
        completedSections++;
        console.log('Educational Details section completed');
    }

    // Bank Details: Check if key fields are present
    if (
        formData.bankDetails?.accountHolder?.trim() &&
        formData.bankDetails?.accountNumber?.trim() &&
        formData.bankDetails?.ifscCode?.trim()
    ) {
        completedSections++;
        console.log('Bank Details section completed');
    }

    // ID Uploads: Check if at least one upload exists
    if (formData.idUploads && Object.keys(formData.idUploads).length > 0) {
        completedSections++;
        console.log('ID Uploads section completed');
    }

    // Previous Company: Check if fresher or at least one employment entry exists
    if (formData.isFresher || (Array.isArray(formData.previousCompany) && formData.previousCompany.length > 0)) {
        completedSections++;
        console.log('Previous Company section completed');
    }

    const progress = Math.round((completedSections / totalSections) * 100);
    console.log(`Progress: ${progress}% (${completedSections}/${totalSections} sections)`);
    return progress;
}

document.addEventListener('DOMContentLoaded', function() {
    addInfoIcons();
    configureDateOfBirth();
    setupInputRestrictions();
    
    const fresherCheckbox = document.getElementById('isFresher');
    if (fresherCheckbox) {
        fresherCheckbox.addEventListener('change', handleFresherCheckbox);
        handleFresherCheckbox();
    }
    
    const currentYear = new Date().getFullYear();
    document.querySelectorAll('.passoutYear').forEach(input => {
        input.max = currentYear;
        input.min = '1990';
    });

    document.querySelectorAll('.percentage').forEach(input => {
        input.addEventListener('input', function(e) {
            let value = e.target.value.replace(/[^\d.]/g, '');
            const decimalPoints = value.split('.').length - 1;
            if (decimalPoints > 1) {
                value = value.replace(/\./g, (match, offset) => offset === value.indexOf('.') ? '.' : '');
            }
            const parts = value.split('.');
            if (parts[0].length > 3) {
                parts[0] = parts[0].substring(0, 3);
            }
            if (parts.length > 1 && parts[1].length > 1) {
                parts[1] = parts[1].substring(0, 1);
            }
            e.target.value = parts.join('.');
        });
    });
    
    document.querySelectorAll('.experience').forEach(input => {
        input.addEventListener('input', function(e) {
            let value = e.target.value.replace(/[^\d.]/g, '');
            const decimalPoints = value.split('.').length - 1;
            if (decimalPoints > 1) {
                value = value.replace(/\./g, (match, offset) => offset === value.indexOf('.') ? '.' : '');
            }
            const parts = value.split('.');
            if (parts[0].length > 2) {
                parts[0] = parts[0].substring(0, 2);
            }
            if (parts.length > 1 && parts[1].length > 1) {
                parts[1] = parts[1].substring(0, 1);
            }
            e.target.value = parts.join('.');
        });
        
        input.addEventListener('keypress', function(e) {
            const value = this.value;
            const char = String.fromCharCode(e.charCode || e.which);
            if (!/[\d.]/.test(char)) {
                e.preventDefault();
                return;
            }
            if (char === '.' && value.includes('.')) {
                e.preventDefault();
                return;
            }
            const parts = value.split('.');
            if (parts[0].length >= 2 && char !== '.' && !value.includes('.')) {
                e.preventDefault();
                return;
            }
            if (parts.length > 1 && parts[1].length >= 1) {
                e.preventDefault();
                return;
            }
        });
    });
    
    const emailInput = document.getElementById('email');
    if (emailInput) {
        emailInput.addEventListener('input', function(e) {
            let value = e.target.value;
            const domains = ['gmail.com', 'yahoo.com', 'outlook.com'];
            for (const domain of domains) {
                const index = value.indexOf(`@${domain}`);
                if (index !== -1 && value.length > index + domain.length + 1) {
                    value = value.substring(0, index + domain.length + 1);
                }
            }
            e.target.value = value;
        });
    }

    const phoneInputs = ['phone', 'guardianPhone'];
    phoneInputs.forEach(inputId => {
        const input = document.getElementById(inputId);
        if (input) {
            input.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length > 10) {
                    value = value.substring(0, 10);
                }
                e.target.value = value;
            });
        }
    });

    const accountNumberInput = document.getElementById('accountNumber');
    if (accountNumberInput) {
        accountNumberInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 18) {
                value = value.substring(0, 18);
            }
            e.target.value = value;
            validateInput(this);
        });
    }
    
    const pincodeInput = document.getElementById('pinCode');
    if (pincodeInput) {
        pincodeInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 6) {
                value = value.substring(0, 6);
            }
            e.target.value = value;
            validateInput(this);
        });
    }

    const dateInputs = document.querySelectorAll('.endDate, .startDate');
    const today = new Date().toISOString().split('T')[0];
    dateInputs.forEach(input => {
        input.setAttribute('max', today);
        input.setAttribute('min', '1990-01-01');
    });

    const form = document.getElementById('onboardingForm');
    if (form) {
        form.querySelectorAll('input[required], select[required]').forEach(input => {
            input.addEventListener('input', function() {
                validateInput(this);
            });
            
            input.addEventListener('blur', function() {
                if (this.value) {
                    validateInput(this);
                }
            });
        });
    }

    document.querySelectorAll('.educationType').forEach(select => {
        select.addEventListener('change', function() {
            updateEducationFields(this);
        });
    });

    addRemoveButtons();

    document.querySelectorAll('input[type="file"]').forEach(fileInput => {
        fileInput.addEventListener('change', function() {
            const allowedTypes = ['image/jpeg', 'image/png', 'application/pdf'];
            if (this.files[0]) {
                if (!allowedTypes.includes(this.files[0].type)) {
                    alert('Invalid file type. Please upload JPG, PNG, or PDF.');
                    this.value = '';
                } else if (this.files[0].size > maxFileSize) {
                    alert('File size should not exceed 1MB.');
                    this.value = '';
                }
            }
        });
    });
});

function updateProgressBar(step) {
    const progressSteps = document.querySelectorAll('.progress-step');
    progressSteps.forEach((stepEl, index) => {
        if (index + 1 <= step) {
            stepEl.classList.add('active');
        } else {
            stepEl.classList.remove('active');
        }
    });
}

function showStep(step) {
    document.querySelectorAll('.step').forEach(stepEl => {
        stepEl.classList.remove('active');
    });
    const stepElement = document.getElementById(`step${step}`);
    if (stepElement) {
        stepElement.classList.add('active');
        updateProgressBar(step);
    }
}

function previousStep(currentStepNum) {
    if (currentStepNum > 1) {
        currentStep = currentStepNum - 1;
        showStep(currentStep);
    }
}

function nextStep(currentStepNum) {
    if (validateStep(currentStepNum)) {
        if (currentStepNum < totalSteps) {
            currentStep = currentStepNum + 1;
            showStep(currentStep);
        }
    }
}

function validateStep(step) {
    const currentStepElement = document.getElementById(`step${step}`);
    if (!currentStepElement) return false;
    
    const inputs = currentStepElement.querySelectorAll('input[required], select[required]');
    let isValid = true;

    inputs.forEach(input => {
        clearError(input);
        
        if (!input.value) {
            isValid = false;
            input.classList.add('error');
            addErrorMessage(input, `${input.previousElementSibling.textContent.replace('*', '').trim()} is required`);
        } else if (!validateInput(input)) {
            isValid = false;
        }
    });

    if (step === 2) {
        isValid = validateEducationEntries() && isValid;
    }
    
    if (step === 5) {
        const fresherCheckbox = document.getElementById('isFresher');
        if (!fresherCheckbox || !fresherCheckbox.checked) {
            isValid = validateEmploymentEntries() && isValid;
        }
    }
    
    if (step === 1) {
        const phone = document.getElementById('phone')?.value;
        const guardianPhone = document.getElementById('guardianPhone')?.value;
        if (phone && guardianPhone && phone === guardianPhone) {
            isValid = false;
            const guardianPhoneInput = document.getElementById('guardianPhone');
            guardianPhoneInput.classList.add('error');
            addErrorMessage(guardianPhoneInput, 'Phone and guardian phone cannot be the same');
        }
    }

    return isValid;
}

document.getElementById('onboardingForm')?.addEventListener('submit', async function(e) {
    e.preventDefault();
    this.setAttribute('data-submitting', 'true');
    
    try {
        for (let step = 1; step <= totalSteps; step++) {
            if (!validateStep(step)) {
                showStep(step);
                return;
            }
        }

        const formData = await collectFormData();
        const savedData = await saveFormData(formData);

        alert(`Form submitted successfully! Your onboarding progress: ${savedData.progress}%`);
        this.reset();
        document.querySelectorAll('.education-entry:not(:first-child), .employment-entry:not(:first-child)').forEach(el => el.remove());
        document.querySelectorAll('.education-entry, .employment-entry').forEach(entry => {
            entry.querySelectorAll('input, select').forEach(input => {
                input.value = '';
                clearError(input);
                if (input.classList.contains('branch')) {
                    input.parentNode.style.display = 'none';
                    input.removeAttribute('required');
                }
                if (input.classList.contains('institutionName')) {
                    input.previousElementSibling.textContent = 'Institution Name';
                }
            });
        });
        currentStep = 1;
        showStep(1);
        document.querySelectorAll('.error-message').forEach(el => el.remove());
        document.querySelectorAll('.error').forEach(el => el.classList.remove('error'));
        handleFresherCheckbox();
    } catch (error) {
        console.error('Form submission error:', error);
        alert(error.message || 'Error submitting form. Please try again.');
    } finally {
        this.setAttribute('data-submitting', 'false');
    }
});
    </script>
</body>
</html>